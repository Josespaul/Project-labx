<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">  
    <title>LabX</title>
    <link rel="stylesheet" href="css/module.css">
    <link rel="stylesheet" href="css/style.css">  
    <link href="https://fonts.googleapis.com/css?family=Rochester" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Poiret+One" rel="stylesheet">  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<script src="https://unpkg.com/vue"></script>-->
    <script src="js/vue.js"></script>
    <script src="js/vue-resource@1.3.4"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <script src="js/jquery.xmlrpc.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.5/require.js"></script>  
      
    <link rel="stylesheet" href="offline/offline-theme-slide.css" />
    <link rel="stylesheet" href="offline/offline-language-english.css" />
    <script src="offline/offline.min.js"></script>
      
    <script language="JavaScript">
   /* <!--
        window.onbeforeunload = bunload;
        function bunload(){
            return "Are you Sure ?"
        }
        
        var run = function() {
        Offline.check()
        }
        setInterval(run, 7000);
        //--> */
    </script>   
  </head>

  <body>
      
    <div v-show="login_screen" style="" id="login">
      
        <ul>
            <li><a href="http://www.zilogic.com">Home</a></li>
            <li><a href="http://www.zilogic.com/blog/">Blog</a></li>    
            <li><a href="http://www.zilogic.com/contact">Contact</a></li>
        <li style="float:right"><a class="active" href="http://www.zilogic.com/training">Training</a></li>
    </ul>        
      <div style="width: 45%; float:left" align="right">
          <h1>
              <object width=50% type="image/svg+xml" data="images/labx-logo.svg">Your browser does not support SVGs</object> 
          </h1>
      </div>
      
      <div style="width: 55%; float:right" align="left">    
	<div id="login">
          <div style="width: 60%; float:left" align="center">
            <h1>Laboratory X</h1>
            <input v-model="login" type="text" placeholder="Username"> <br>
            <input v-on:keyup.enter="submit" v-model="pass" type="password" placeholder="Password"> <br>
             
              <button v-show= "submit_button" type="submit" v-on:click="submit">Login</button>
            <b v-show="loading" class="fa fa-spinner fa-spin" style="padding: 12px 20px; margin: 8px 0; margin-bottom: 30px; font-size: 30px"></b>
            <br>
            <h4><a>Or</a></h4>
            <button type="oauth" style="background-color:dodgerblue;" onclick="location.href='https://oauth.net/2/'" >
              <b class="fa-twitter"></b></button>        
            <button type="oauth" style="background-color: #d34836;" onclick="location.href='https://oauth.net/2/'" >
              <b class="fa-google"></b></button>
            <button type="oauth" style="background-color: #3b5998;" onclick="location.href='https://oauth.net/2/'" >
              <b class="fa-facebook"></b></button>
            <button type="oauth" style="background-color:black;" onclick="location.href='https://oauth.net/2/'" >
              <b class="fa-github"></b></button>
        </div>
	</div>        
        </div>
    </div>
      
      
    <div v-show='page' id="modules">
    <ul>
        <li><a href="http://www.zilogic.com" target="_blank">Home</a></li>
        <li><a href="http://www.zilogic.com/blog/" target="_blank">Blog</a></li>
        <li><a href="http://www.zilogic.com/training" target="_blank">Training</a></li>
        <li style="float:right"><a class="active" v-on:click="logout">&nbsp;Logout</a></li>
    </ul>     
    <section id="three" class="wrapper align-center">
      <div class="inner">
	<div class="flex flex-2">
	  <article>
	    <div class="image round">
	      <img src="images/device.png" alt="Pic 01" />
	    </div>
	    <header>
	      <h3>Linux Device Drivers</h3>
	    </header>
	    <footer>
	      <a class="button" v-on:click='select_module'>Load Exercise</a>
	    </footer>
	  </article>
	  
	  <article>
	    <div class="image round">
	      <img src="images/interface.png" alt="Pic 02" />
	    </div>
	    <header>
	      <h3>Linux Kernel Porting</h3>
	    </header>
	    <footer>
	      <a href="#" class="button_comming" font-color='black'>Comming Soon</a>
	    </footer>
	  </article>
	  
	  <article>
	    <div class="image round">
	      <img src="images/xv61.png" alt="Pic 02" />
	    </div>
	    <header>
	      <h3>Understanding XV6</h3>
	    </header>
	    <footer>
	      <a href="#" class="button_comming">Comming Soon</a>
	    </footer>
	  </article>        
	</div>
      </div>
    </section>
    </div>
      
      <div id="modal">
      <div id="id01" class="w3-modal">
        <div class="w3-modal-content">
        <br>
        <span onclick="document.getElementById('id01').style.display='none'" class="w3-button w3-xlarge w3-hover-red w3-display-topright" >&times;</span>    
            <center>
                <h2> Select Task </h2>
                    
                <div class="w3-container w3-border-top w3-padding-16 w3-light-grey">
                <span style=" font-family: 'Poiret One', cursive;
                font-weight: bold;font-size: 12pt; font-size: 22px"> Task Details </span></div>
                <!--
                <div style="width:100%; float:left" align="center">
                <span style=" font-family: 'Poiret One', cursive;
        font-weight: bold;font-size: 12pt; font-size: 22px">
                    <center>
                        {{ mouseover_task }} <br>
                    "{{ mouseover_task_details }}" <br><br>
                    {{ mouseover_task_status }} <br>
                    <img src="images/completed.png" style="display:inline; margin:0px;">
                    </center>
                    </span>
                </div>-->
                <div id="task_details" v-if="refresh_task">
                <div style="width:50%; float:left" align="right">
                <span style=" font-family: 'Poiret One', cursive;
        font-weight: bold;font-size: 12pt; font-size: 22px">
                        {{ mouseover_task }} <br>
                    {{ mouseover_task_details }} <br>
                    </span>
                </div>
                <div style="width:49.5%; float:right; padding-left: 0.5vh; display: inline" align="left">
                <span style=" font-family: 'Poiret One', cursive;
        font-weight: bold;font-size: 12pt; font-size: 22px"> {{ mouseover_task_status }} </span><br>
                    <div style="display:inline" v-if= "mouseover_task_status == 'NEW'">
                    <img src="images/new_progress.png" style="display:inline; margin:0px;">
                    </div>
                    <div style="display:inline" v-if= "mouseover_task_status == 'COMPLETED'">
                    <img src="images/completed.png" style="display:inline; margin:0px;">
                    </div>
                    <div style="display:inline" v-if= "mouseover_task_status == 'IN_PROGRESS'">
                    <img src="images/inprogress.png" style="display:inline; margin:0px;">
                    </div>
                    
                </div>
                <center>
                <ul class=task> 
                    <li id=task
                    v-for="(value, key, index) in task[0]"
                    v-on:mouseover="mouseover_task_details = task[0][key].title;
                                    mouseover_task_status = task[0][key].status;
                                    mouseover_task = key;
                                    mouseover_task_index = index;
                                    "
                        
                    v-on:click="selected_task_details = task[0][key].title;
                                selected_task_status = task[0][key].status;
                                selected_task = key;
                                selected_task_index = index;
                                setup_wb();
                                get_next_task();
                                get_prev_task();
                            "
                    :class="'task-' + task[0][key].status"     
                        >
                               {{index+1}}
                    </li>    
                </ul>
                </center><br>
                    </div>
            </center>
        <div class="w3-container w3-border-top w3-padding-16 w3-light-grey">
        <!--<button v-on:click="show_about" type="about" class="w3-button">About</button>-->
        <!--<button v-on:click="restore_mouseover_task" type="button" class="w3-button">Reset</button>-->    
        </div>
        </div>
        </div>
          
         <div id="info" class="w3-modal">
        <div class="w3-modal-content">
        <br>
        <span onclick="document.getElementById('info').style.display='none'" class="w3-button w3-xlarge w3-hover-red w3-display-topright" title="Close">&times;</span>    
            <center>
                <h2> Task Complete ! </h2>            
                <div class="w3-container w3-border-top w3-padding-16 w3-light-grey">
                </div>
                <span style="font-family: 'Poiret One', cursive; font-weight:bold; font-size: 3.5vh"> {{selected_task}} <br> "{{selected_task_details}}" </span>
                <br><br>
                <img src="images/star.png" >
                <img src="images/star.png" >
                <img src="images/star.png" >
            </center>
        <div class="w3-container w3-border-top w3-light-grey">
            <center><br>
        <button v-on:click="load_next_task" type="next" class="w3-button">Next >></button>
            </center>    
        </div>
        </div>
        </div> 
          
          
      </div>
      
    <div id="workspace" v-show="testings">
        
        <ul>
        <li><a href="http://www.zilogic.com" target="_blank" >Home</a></li>
        <li><a href="http://www.zilogic.com/blog/" target="_blank">Blog</a></li>
        <li><a href="http://www.zilogic.com/training" target="_blank">Training</a></li>
        <li style="float:right">
            <a class="active" v-on:click="logout">Logout</a></li>
        <li style="float:right"><a class="active" v-on:click="load_modules_page" >Modules</a></li>
        <li style="float:right"><a class="active" v-on:click="select_module" >Tasks</a></li>
    </ul>
        
      <div style="width: 50%; float:left;" align="left">
        
        <div id="window">
 	  <!--<div id="toolbar">
	    <div class="top">
	      <div id="lights">
		<div class="light red" v-on:click="select_red">
		  <div class="glyph"></div>
		  <div class="shine"></div>
		  <div class="glow"></div>
		</div>				
		<div class="light yellow" v-on:click="select_yellow">
		  <div class="glyph"></div>
		  <div class="shine"></div>
		  <div class="glow"></div>
		</div>
		<div class="light green" v-on:click="select_green">
		  <div class="glyph"></div>
		  <div class="shine"></div>
		  <div class="glow"></div>
		</div>
	      </div>
	      <div id="terminaltitle">
	      </div>
	      <div id="bubble">
		<div class="shine"></div>
		<div class="glow"></div>
	       </div>
	    </div>
	  </div>-->
            
	  <div id="terminalbody">
         <!-- <p id="terminalp" style="color: #63de00;">{{ printscreen }} </p>-->
          <p id="terminalp" style="color: white">{{ printscreen }} </p>
          <!--
          <div id="cursorx" class="cursor" style="color: #ffffff;"></div>
          -->
	  </div>        
	</div>
	<center>
          <input id="command" v-model="command" type="command" placeholder="command"
                 onkeydown = "workspace.input_key()"
                 @keydown.ctrl.67="special_key_event"
                 @keydown.ctrl.68="special_key_event"
                 @keydown.ctrl.90="special_key_event"
                 >
          <button id="bb8" type="send" v-on:click="sendcommand()">Send</button>
          <button type="wb_reset" v-on:click="wb_reset">Reset</button>
        </center>
        <center>
        <div id="device_space" align="center" style="margin-top:0.5vh; width: 70%; display: inline-block">
             <object id="board" width="100%" type="image/svg+xml"  data="images/simple-borad.svg">Your browser does not support SVGs</object>    
            </div>  
        </center>
          <br>
      </div>
      
      <div style="width: 50%; float:right" align="center">      
        <!--  <h1><img src="labx-logo.png"></h1> -->
        
        <div v-show=!show_led>
          <ul class="menu">
        <li class="menu" style="float:right"><a v-on:click="wbench_check">Check
            <span id="check_status" class="status"></span>
            <div id="check_loader" class="sk-fading-circle">
        <div class="sk-circle1 sk-circle"></div>
        <div class="sk-circle2 sk-circle"></div>
        <div class="sk-circle3 sk-circle"></div>
        <div class="sk-circle4 sk-circle"></div>
        <div class="sk-circle5 sk-circle"></div>
        <div class="sk-circle6 sk-circle"></div>
        <div class="sk-circle7 sk-circle"></div>
        <div class="sk-circle8 sk-circle"></div>
        <div class="sk-circle9 sk-circle"></div>
        <div class="sk-circle10 sk-circle"></div>
        <div class="sk-circle11 sk-circle"></div>
        <div class="sk-circle12 sk-circle"></div>
            </div>
            <!--<div class="build_loader" id="check_loader"></div>-->
            </a></li>
        <li class="menu" style="float:right"><a v-on:click="wbench_build">Build
            <span id="build_status" class="status"></span>
            
             <div id="build_loader" class="sk-fading-circle">
        <div class="sk-circle1 sk-circle"></div>
        <div class="sk-circle2 sk-circle"></div>
        <div class="sk-circle3 sk-circle"></div>
        <div class="sk-circle4 sk-circle"></div>
        <div class="sk-circle5 sk-circle"></div>
        <div class="sk-circle6 sk-circle"></div>
        <div class="sk-circle7 sk-circle"></div>
        <div class="sk-circle8 sk-circle"></div>
        <div class="sk-circle9 sk-circle"></div>
        <div class="sk-circle10 sk-circle"></div>
        <div class="sk-circle11 sk-circle"></div>
        <div class="sk-circle12 sk-circle"></div>
            </div>
            
            <!--<div class="build_loader" id="build_loader"></div>-->
            </a></li>
        <li class="menu" style="float:right;"><a v-on:click="wbench_save">Save
            <span id="save_status" class="status"></span>
            
            <div id="save_loader" class="sk-fading-circle">
        <div class="sk-circle1 sk-circle"></div>
        <div class="sk-circle2 sk-circle"></div>
        <div class="sk-circle3 sk-circle"></div>
        <div class="sk-circle4 sk-circle"></div>
        <div class="sk-circle5 sk-circle"></div>
        <div class="sk-circle6 sk-circle"></div>
        <div class="sk-circle7 sk-circle"></div>
        <div class="sk-circle8 sk-circle"></div>
        <div class="sk-circle9 sk-circle"></div>
        <div class="sk-circle10 sk-circle"></div>
        <div class="sk-circle11 sk-circle"></div>
        <div class="sk-circle12 sk-circle"></div>
            </div>
            
            
            
            
            </a></li>
        <li class="menu" style="float:right"><a v-on:click="wbench_restore_task">Reset&nbsp;&nbsp;</a></li>

        <div class="dropdown">
            <button class="dropbtn">File <i class="fa fa-caret-down"></i></button>
            <div class="dropdown-content">
                
                <li v-for="file in task_file_list" v-on:click="active_file = file; select_file();"><center>{{ file }}</center></li>
                
                <!--<li v-on:click="file_c"><center>C</center></li>
                <li v-on:click="file_make"><center>Makefile</center></li>
                <li v-on:click="file_build"><center>Build.log</center></li>-->
            </div>
        </div>
        <li class="menu" style="float:left" style="
        font-family: 'Rochester', cursive;
        font-size: 2.7vh;
        letter-spacing: 0.1vh;
        font-weight: normal;                                                   
                    "
        ><a v-on:click="select_module">{{ active_task }}</a></li>
    </ul>       
          </div>
          
     <div style="height: 46vh; width: 97%;">
    
    <div id="editor" style="padding: 0; margin: 0; width:100%; height: 100%;"></div>
         
<!--
    <editor editor-id="editorA" :content="code" v-on:change-content="changecontent"></editor>     
-->
     </div>
          
          <!--<div v-show=true align="right" style="margin-right:2%;">
            <button v-show=true type="device" v-on:click="show_device"> {{ plus }} </button>
          </div>   -->
          
              <center>
          	  <div id="output">
               <ul class="tab" >
                   <li id="objective" class="menu" style="
                    float:left; 
                    width:50%;
                    font-size: 2vh;
                    font-weight: bold;
                    font-family: 'Poiret One', cursive;"
                    ><a v-on:click="select_objective">Task Objective&nbsp;&nbsp; </a></li>
                   
                   <li id="build_output" class="menu" style="
                    float:left; 
                    width:50%;
                    font-size: 2vh;
                    font-weight: bold;
                    font-family: 'Poiret One', cursive;"
                   ><a v-on:click="select_build_output">Build Output&nbsp;&nbsp; </a></li>
                   
               </ul>   
              <div id="objective_content" v-show=show_task_objective>
                  <div id="goal_table">
                <div id="goal">
                  </div>
                <img src="images/goal.png" style="width: 10vh; margin-top: 1em;">
                </div>
                  </div>
      
              <div v-if=show_build_output>  
            <table style="width:100%" align='center'>
  <tr align="center">
    <th>#</th>
    <th>File</th> 
    <th>Line</th>
    <th>Description</th>
  </tr>
  
  <tr v-for="(value,key) in errors" align='center' 
      v-on:click="
             selected_error = errors[key].message;
             selected_error_line = errors[key].line;
             selected_error_index = key;
             al()" > 
     <td>{{ errors[key].type }}</td>
    <td>{{ errors[key].filename }}</td>
    <td>{{ errors[key].line }}:{{ errors[key].col }}</td>
    <td align="left">{{ errors[key].message }}</td>
  </table>
    </div>              
                  
         <!-- <p id="terminalp" style="color: #63de00;">{{ printscreen }} </p>-->
                <!--
          <div id="cursorx" class="cursor" style="color: #ffffff;"></div>
          -->
	  </div>
            </center>
          </div>
          
        </div>
<!--        <p>{{ code }}</p> -->  
            
    <script src="editor/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script>        
    const ws_url = 'wss://lab.zilogic.com/events';
    const xmlrpc_url = 'https://cors-anywhere.herokuapp.com/https://lab.zilogic.com/rpc';
    const new_xmlrpc_url = 'https://lab.zilogic.com/rpc';  
    //-------------------- Editor ------------------------------------------------
/*
const apple = new Vue({
	el: "#apple",
  data () {
  	return {
      contentA: 'default content for Editor A'
    }
  },
  methods: {
    changeContentA (val) {
    	if (this.contentA !== val) {
      	this.contentA = val
      }
    },
   
  }
})
*/
    
    //----------------- ----------------- -------------------- ---------------------    
    //------------------------------------------------------------------------------       
    //------------------------------------- VUE JS ---------------------------------
    //---------------------------- # Module # --------------------------------------
    
      var modules = new Vue({
      el: '#modules',
      data: {
      page : false,
      websoc_state: false,      
      autoload : true,
      lcd: '',
      },
      methods: {    
      select_module() { 
          //-------------------------- # WebSoc # ------------------------
          if (this.websoc_state == false) {
          this.websoc_state = true;  
          var ws = new WebSocket(ws_url);
          ws.onopen = function (event) {
             // alert('' + login.$data.key + '');
             ws.send(login.$data.key);
          };
          ws.onmessage = function (event) {
             var wsevent_data = JSON.parse(event.data);
              
              if (wsevent_data.type == 'leds') {
                  //alert("led_event_detected");
                var object = document.getElementById("board");
                var svgDocument = object.contentDocument;
                var led = 'led' + wsevent_data.index;  
                /*alert('' + led + '');*/
                var svgled = svgDocument.getElementsByClassName(led);
                if (wsevent_data.value == true) {
                    svgled[0].style.fill = "#ff3232" ;
                } else if (wsevent_data.value == false) {
                    svgled[0].style.fill = "#b3b3b3" ;
                }
              }
              
              if (wsevent_data.type == 'terminal') { 
                workspace.$data.printscreen = workspace.$data.printscreen +   wsevent_data.append;
                $("#window").animate({ scrollTop: $("#terminalp").height() }, 10);
             }
          } 
          }
        //----------------------------------------------------------------- 
          modal.get_tasks();
      }, 
          
      logout() {
        this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('logout', [login.$data.key]))).then(response => this.buffer) 
        
        window.location.reload(true);
      },

      }
      })
      
      var modal = new Vue({
          el:'#modal',
          data: {
            task_json: [{}],
            task: '',
            task_id:'',
              
            mouseover_task : '-',
            mouseover_task_details : '',
            mouseover_task_status : '-',
            mouseover_task_index : 0,
              
            selected_task: '',
            selected_task_status:'',  
            selected_task_details: 'Select Task',
            selected_task_index: 0,
            update_selected_task_info : false,
              
            next_task: '',
            next_task_status: '',
            next_task_details: '',  
            next_task_index: 0,
              
            total_tasks: 0,
            tasks_list: 0,
            autoload: true,
              
            refresh_task: true,
          },
          methods : {
              task_status_color() {
              if (this.mouseover_task_status == 'NEW'){
                  document.getElementById('task').style.background='red';
              }    
              },
              
              show_about() {
                  
              },
              
              restore_mouseover_task() {
                alert(''+ login.$data.key + ' -- ' + modal.$data.selected_task + '' )
          this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('restore_task', [login.$data.key,'ldd',modal.$data.mouseover_task]))).then(response => {
              console.log(response);
              if(modal.$data.mouseover_task == modal.$data.selected_task) {
              workspace.wb_load();
              this.update_selected_task_info = true;      
              }
              modal.get_tasks();
          }); 
              },
              
               get_next_task() {
            if (this.selected_task_index < (this.total_tasks - 1) ){
                //alert(this.total_tasks + '/' + this.selected_task_index + '  ' + this.tasks_list[this.selected_task_index])
                this.next_task_index = (this.selected_task_index + 1);
                this.next_task = this.tasks_list[this.next_task_index]
                this.next_task_status = this.task[0][this.next_task].status
                this.next_task_details = this.task[0][this.next_task].title
                //alert(this.next_task);
            } else {
                this.next_task = 'NONE';
                //alert(this.next_task);
            }
        },
        
        load_next_task() {
            if(this.next_task == 'NONE') {
             document.getElementById('info').style.display='none';       
             alert("Module Complete")
            } else {
             this.selected_task_index = this.next_task_index;     
             this.selected_task = this.next_task;
             this.selected_task_details = this.next_task_details;
             this.selected_task_status = this.next_task_status;
                
             this.mouseover_task_index = this.next_task_index;     
             this.mouseover_task = this.next_task;
             this.mouseover_task_details = this.next_task_details;
             this.mouseover_task_status = this.next_task_status;  
                
             this.get_next_task();
             workspace.wb_load();
          document.getElementById('info').style.display='none';             
            }
        },
              
            get_prev_task(){    
            },
            
        
              get_tasks() {
          this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('get_tasks', [login.$data.key, 'ldd']))).then(response => {
          console.log(response)    
          this.task = response.body;  
            var parser = new DOMParser();                          
        tasks = parser.parseFromString(this.task, "text/xml");  //xml-string to xml-object
        tasks = $.xmlrpc.parseDocument(tasks); //xml object -> json object
        this.task_json = tasks
        var sort_task = [{}]
            var keys = Object.keys(tasks[0]);
            this.tasks_list = keys;  
            var len = keys.length;
            this.total_tasks = keys.length;
            var i;
            keys.sort();
            for (i = 0; i < len; i++) {
                k = keys[i];
                sort_task[0][k] = tasks[0][k];
            }
            this.task = sort_task;  
              /*FIXME      JAVASCRIPT STRING == JSON ;*/
        //alert(JSON.stringify(obj, null, 4));
        //alert(JSON.stringify(obj[0]));
        /*for (var x in this.task[0]){
        	   //alert(x);
			   //alert(obj[0][x].title);
               
               for (var y in obj[0][x].files){
               //alert(obj[0][x].files[y]);
               }     
			}*/
              
            modal.$data.refresh_task = false;
            modal.$data.refresh_task = true;
             if(this.update_selected_task_info){
            modal.$data.mouseover_task_index = modal.$data.selected_task_index;     
            modal.$data.mouseover_task = modal.$data.selected_task;
            modal.$data.mouseover_task_details = modal.$data.task[0][modal.$data.selected_task].title;
            modal.$data.mouseover_task_status =  modal.$data.task[0][modal.$data.selected_task].status;
            this.update_selected_task_info = false;     
              }
              
           document.getElementById('id01').style.display='block'; 
            })      
        },
        
        setup_wb() {
          document.getElementById('id01').style.display='none'; 
          login.$data.login_screen = false;
          modules.$data.page = false;
          workspace.$data.testings = true;
          workspace.wb_load(); 
          workspace.ace_settings();
            
          if (this.autoload == true) {
            this.autoload = false;  
            workspace.wb_reset();
            }
        },
              
          }
      })
      
     //-------------------------- # Workspace # ------------------------        
      var workspace = new Vue({
        el: '#workspace',
        data: {
        editor: Object, 
        raw_code : '',
        server_code: '',
        code : '',
        command : '',
        pre_command: '',
        printscreen : 'Gnu-linux | Last login: Tue Dec 13 09:01:16',
        testings : false, //FIXME
        modules: false,
        active_task: '',
        active_file: '',
        show_led: false,
        plus: "Device",
        lcd_data: "",
        obj_task: [{}],
        task_file_list: [{}],
        wbench_save_status: 0,
        wbench_build_status:0,
        command_history: [],
        h_counter: -1,
        file_permission_info: {}, 
        file_mime_info: {},
        errors: [],
        selected_error : '',
        selected_error_line: 0,
        selected_error_index: 0,    
        build: 0,
        show_build_output : false,
        show_task_objective: true,
        goal: '',    
        temp: "",    
        }, 
          
        watch: {
    	'code': function(val, oldVal){
      	     if (this.code == this.server_code) {
                document.getElementById("save_status").style.background = "green";
                this.wbench_save_status = 1;
                document.getElementById("build_status").style.background = "grey";
            }else{
                document.getElementById("save_status").style.background = "red";
                document.getElementById("build_status").style.background = "#333";
                document.getElementById("check_status").style.background = "#333";       
                this.wbench_save_status = 0; // needs saving
                this.wbench_build_status = 0; // needs build
            }
         }
        },
        mounted () {
            this.ace_settings()
            for (j in this.build){
          if (this.build[j][1] != null){
             this.errors.push(this.build[j][1]);
                }
           }
        }, 
          
        methods : {
        select_objective () {
        this.show_task_objective = true;
        this.show_build_output = false;  
        document.getElementById("objective").style.background = "black";    
        document.getElementById("build_output").style.background = "#333";
        //document.getElementById("output").style.background = "#333";
        //document.getElementById("output").style.color = "black";       
        document.getElementById("goal").innerHTML = this.goal; 
        },

        select_build_output () {
        document.getElementById("objective").style.background = "#333";
        document.getElementById("build_output").style.background = "black";
        //document.getElementById("output").style.background = "#333";
        //document.getElementById("output").style.color = "white";    
        this.show_task_objective = false;
        this.show_build_output = true;   
        },
            
        build_error() {
            alert("Building Errors");
          for (j in this.build){
          if (this.build[j][1] != null){
             this.errors.push(this.build[j][1]);
                } 
            }
            alert(JSON.stringify(this.errors)) 
          },
                            
        al() {
            //alert(this.selected_error_index);
            var range = ace.require(`ace/range`).Range;    
            
            this.editor.getSession().addMarker(new range(this.errors[this.selected_error_index].line - 1, 0, 
            this.errors[this.selected_error_index].line - 1, 1), 'error', 'fullLine', false);
            
            },
            
        special_key_event (){
            if (event.keyCode == 67){
                this.send_special_command('\x03')
                //alert('ctrl+c')
            }
            if (event.keyCode == 68){
                this.send_special_command('\x04')
                //alert('ctrl+d') 
            }
            if (event.keyCode == 90){
                this.send_special_command('\x1A')
                //alert('ctrl+z') 
            }
        },
        send_special_command ( special_command ) {
        this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('wbench_run_command', [login.$data.key,this.tobase64(special_command)]))).then(response => {})
        },
            
        tobase64 (command) { 
            base64 = btoa(command)    
            var binary_string =  atob(base64);
            var len = binary_string.length;
            var bytes = new Uint8Array( len );
            for (var i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        },
    
        ace_clear_undo() {
                this.editor.getSession().setUndoManager(new ace.UndoManager());  
        },
            
        ace_settings() {     
        const lang = 'c_cpp'
        const theme = 'kuroir'
        /* - Best Themes -
        chrome cobalt gruvbox idle_fingers kuroir xcode
        */

        this.editor = ace.edit("editor")
        //this.editor.setHighlightActiveLine(true);
        //this.editor.setHighlightGutterLine(true);
        //this.editor.session.setOption("useWorker", false)    
        // mode-xxx.js or theme-xxx.jsがある場合のみ有効
        this.editor.getSession().setMode(`ace/mode/${lang}`)
        this.editor.setTheme(`ace/theme/${theme}`)
        //this.editor.setKeyboardHandler("ace/keyboard/emacs")
        this.editor.setOptions({
            fontSize: "12.5pt",
            display: "none",
            useWorkers: false,
        });
        this.editor.on('change', () => {
            this.code = this.editor.getValue()
        })
        this.editor.commands.addCommand({
            name: 'wbench_save_shortcut',
            bindKey: {win: 'Ctrl-s',  mac: 'Command-s'},
            exec: function(editor) {
            workspace.wbench_save();
            },
            readOnly: false // false if this command should not apply in readOnly mode
        })
        this.editor.commands.addCommand({
            name: 'wbench_build_shortcut',
            bindKey: {win: 'Ctrl-b',  mac: 'Command-b'},
            exec: function(editor) {
            workspace.wbench_build();
            },
            readOnly: false // false if this command should not apply in readOnly mode
        })
        
        this.editor.commands.addCommand({
            name: 'wbench_check_shortcut',
            bindKey: {win: 'Ctrl-r',  mac: 'Command-r'},
            exec: function(editor) {
            workspace.wbench_check();
            },
            readOnly: false // false if this command should not apply in readOnly mode
        })    
          },
            
        update_board(){
            var object = document.getElementById("board");
                var svgDocument = object.contentDocument;
                var svgb1 = svgDocument.getElementsByClassName("led1");
                svgb1[0].style.fill = "#ff3232" ;
        },   
            
        input_key(){    
            var old = this.pre_command;
          if (event.keyCode == 13) //Enter
            document.getElementById('bb8').click()
          if (event.keyCode == 38) {
              if (this.h_counter < this.command_history.length){
              this.h_counter = this.h_counter + 1;
              this.command = this.command_history[this.h_counter]
              //alert('up' + this.command_history[this.h_counter])
            //this.temp = this.command;  
            //this.command = old;
          }
          }
          if (event.keyCode == 40){
              if (this.h_counter > 0){
            //this.command = this.temp;
              this.h_counter = this.h_counter - 1;
              this.command = this.command_history[this.h_counter]
              //alert('down' + this.command_history[this.h_counter])
          }
          }
        },   
        select_module(){  //FIXME: This should be renamed to show_select_module
            // -------------------------- Refresh Select -------------------//
            modal.get_tasks();
            modal.$data.update_selected_task_info = true;
            //document.getElementById('id01').style.display='block';         
        },    
        load_modules_page(){
          login.$data.login_screen = false;
          modules.$data.page = true;
          workspace.$data.testings = false;
        },
            
        logout() {
            this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('logout', [login.$data.key]))).then(response => this.buffer) 
            
            window.location.reload(true);
        },
        select_file() {
        this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('wbench_get_file_info_all', [login.$data.key]))).then(response => {
            console.log(response);
            file_info = response.body;  
            var parser = new DOMParser();                          
            file_info = parser.parseFromString(file_info, "text/xml");  //xml-string to xml-object
            file_info = $.xmlrpc.parseDocument(file_info); //xml object -> json object
            for (index in file_info[0]) {
                this.file_permission_info[file_info[0][index]["name"]] = file_info[0][index]["ro"]
                this.file_mime_info[file_info[0][index]["name"]] = file_info[0][index]["mime_type"]
            }
        })

        this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('wbench_read', [login.$data.key,this.active_file]))).then(response => {
        console.log(response)
        this.raw_code = response.body; 
        this.xml_parser(this.raw_code); 
        this.editor.setValue(this.code, 1);
        /*FIXED -- FILE PROPERTY */
        if(this.file_permission_info[this.active_file] == true ){
            this.editor.setReadOnly(true);
        } else {
            this.editor.setReadOnly(false);
        }
        this.editor.gotoLine(1, 0, true);
        })
        },

        wb_load() {
            this.obj_task = modal.$data.task_json;
            this.task_file_list = this.obj_task[0][modal.$data.selected_task].files
            //workspace.$data.task_file_list = tasks[0][this.selected_task].files
            this.active_file = this.obj_task[0][modal.$data.selected_task].files[0]
            
            /*this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('get_tasks', [login.$data.key, 'ldd']))).then(response => {this.temp = response.body;})
            */    
            this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('open_task', [login.$data.key,'ldd',modal.$data.selected_task]))).then(
                response => {
                             console.log(response)
                             response = response.body;
                    
            var goal, parser;
            parser = new DOMParser();                          
            goal = parser.parseFromString(response, "text/xml");  //xmlstr -> xmlobj
            goal = $.xmlrpc.parseDocument(goal);
            this.goal = goal; //this.goal will be used when vue reload the Objective DOM.
            document.getElementById("goal").innerHTML = this.goal     
                    
                    this.active_task = modal.$data.selected_task;
                    this.select_file();
                    this.ace_clear_undo();
                    this.select_objective();
          })
            
        },
            
        wb_reset() {
            this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('wbench_reset', [login.$data.key]))).then(response => { console.log(response);
                this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('wbench_run_command', [login.$data.key, this.tobase64('\n')]))).then(response => this.buffer)
            })
        },

        xml_parser() {
            var text = this.raw_code;
            var parser, xmlDoc;
            parser = new DOMParser();
            xmlDoc = parser.parseFromString(text,"text/xml");
            this.server_code = xmlDoc.getElementsByTagName("string")[0].childNodes[0].nodeValue;
            this.code = this.server_code;
        },

        sendcommand() {
        this.ace_clear_undo();    
        //var range = ace.require(`ace/range`).Range;    
        //this.editor.getSession().addMarker(new range(1, 0, 1, 1), 'error', 'fullLine', false);
            
        /* this.editor.session.setAnnotations([{row:1 ,column: 0, text: 
"Invalid Syntax",type:"error"}]); */ 
        //this.printscreen = this.printscreen + '\n' + 'root@Labx:# '+ this.command;
        //alert('-' + this.temp + '-');
            //alert('command --->' + this.command)
            this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('wbench_run_command', [login.$data.key,this.tobase64(this.command + '\n')]))).then(response => {
           
                if(this.command != "") {
                this.command_history.unshift(this.command);
                }
                //alert(this.command +' -- ' + this.command_history[0])
                if( this.command_history.length > 20) {
                    this.command_history = this.command_history.splice(0,20);
                }
                this.h_counter = -1;
                this.command = "";
                $("#window").animate({ scrollTop: $("#terminalp").height() }, 10);
            }) 
            if (this.command == "clear") {
                this.printscreen = '';
            }
            //++FIXME
            //this.editor.setTheme(`ace/theme/cobalt`)
            //this.editor.setValue(this.code, 1)
            if (this.command == "lcd_data") {
                var object = document.getElementById("board");
                var svgDocument = object.contentDocument;
                var svgb1 = svgDocument.getElementsByClassName("lcd_data");
                svgb1[0].textContent = " Now you see Me ! Hah!" ;
                svgb1[0].textContent = "123456789012345678901234567890" ;
            }
            if (this.command == "lcd") {
                var object = document.getElementById("board");
                var svgDocument = object.contentDocument;
                var svgb1 = svgDocument.getElementsByClassName("lcd_bl");
                svgb1[0].style.fill = "#afe9af" ;
            }
            if (this.command == "led1") {
                var object = document.getElementById("board");
                var svgDocument = object.contentDocument;
                var svgb1 = svgDocument.getElementsByClassName("led1");
                svgb1[0].style.fill = "#ff3232" ;
            }
            if (this.command == "led2") {
                var object = document.getElementById("board");
                var svgDocument = object.contentDocument;
                var svgb1 = svgDocument.getElementsByClassName("led2");
                svgb1[0].style.fill = "#ff3232" ;
            }
            if (this.command == "led3") {
                var object = document.getElementById("board");
                var svgDocument = object.contentDocument;
                var svgb1 = svgDocument.getElementsByClassName("led3");
                svgb1[0].style.fill = "#ff3232" ;
            }
            if (this.command == "led4") {
                var object = document.getElementById("board");
                var svgDocument = object.contentDocument;
                var svgb1 = svgDocument.getElementsByClassName("led4");
                svgb1[0].style.fill = "#ff3232" ;
            }
            //--FIXME
            this.pre_command = this.command;
            //this.command = ""; //clearing the commandbox
        },
  
        wbench_save() {
            document.getElementById("save_status").style.display = "none";
            document.getElementById("save_loader").style.display = "inline-block";    
            this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('wbench_save', [login.$data.key,this.active_file,this.code]))).then(response => {
            document.getElementById("save_loader").style.display = "none";
            document.getElementById("save_status").style.background = "green";
            document.getElementById("save_status").style.display = "inline-block";
            this.wbench_save_status = 1;
            document.getElementById("build_status").style.background = "grey";
            })
        },    
            
        wbench_build() {
            if(this.wbench_save_status == 0) {
            return
            }
            document.getElementById("build_status").style.display = "none";
            document.getElementById("build_loader").style.display = "inline-block";
            this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('wbench_build', [login.$data.key]))).then(response => { console.log(response);
               this.errors.length = 0;
               this.build.length = 0;
               var annotations = this.editor.getSession().getAnnotations();
               annotations.length = 0;
               
                var text = response.data;
                    var parser, xmlDoc;
                    parser = new DOMParser();
                    xmlDoc = parser.parseFromString(text,"text/xml");
                    var xml_build_errors = xmlDoc.getElementsByTagName("string")[0].childNodes[0].nodeValue;
                    this.build = JSON.parse(xml_build_errors);
                
                    var build_status = xmlDoc.getElementsByTagName("boolean")[0].childNodes[0].nodeValue;
                    if ( build_status == '1') {
                    document.getElementById("build_status").style.display = "inline-block";
                    document.getElementById("build_status").style.background = "green";
                    document.getElementById("build_loader").style.display = "none";
                    this.wbench_build_status = 1; // Build Passed.
                    this.errors.pop(); //Vuejs - updates DOM only on array manuplation.
                    this.editor.getSession().clearAnnotations()
                    document.getElementById("check_status").style.background = "grey";    
                    }
                    else if ( build_status == '0' ){
                    document.getElementById("build_status").style.display = "inline-block";
                    document.getElementById("build_status").style.background = "red";
                    document.getElementById("build_loader").style.display = "none";
                    document.getElementById("check_status").style.background = "#333";
                    this.wbench_build_status = -1; //Build Failed, with errors.
                    
                    var error_icon = "error";
                    for (errors in this.build){
                        if (this.build[errors][1] != null){
                            this.errors.push(this.build[errors][1]);
                            if (this.build[errors][1].type != "error") {
                                error_icon = "warning";
                            }
                            annotations.push({
                                row:  this.build[errors][1].line - 1,
                                column: 0, 
                                text: this.build[errors][1].message,
                                type: error_icon,
                            });    
                            }
                        }    
                    this.editor.getSession().setAnnotations(annotations);   
                    this.select_build_output()
                    }
                //this.select_file()
            })
        },

        wbench_check() {
            if (this.wbench_build_status == 0) {
                return
            } else if (this.wbench_build_status == -1) {
                return   
            }
            document.getElementById("check_status").style.display = "none";
            document.getElementById("check_loader").style.display = "inline-block";
            if (this.wbench_build_status == 1) {
            this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('wbench_check', [login.$data.key]))).then(response => { 
                    console.log(response);
                    var text = response.data;
                    var parser, xmlDoc;
                    parser = new DOMParser();
                    xmlDoc = parser.parseFromString(text,"text/xml");
                    var check = xmlDoc.getElementsByTagName("boolean")[0].childNodes[0].nodeValue;
                    if (check == '1') {
                        document.getElementById("check_status").style.display = "inline-block";
                        document.getElementById("check_status").style.background = "green";
                        document.getElementById("check_loader").style.display = "none";    
                        document.getElementById('info').style.display='block';      
                    }
                    else if (check == '0') {
                        document.getElementById("check_status").style.display = "inline-block";
                        document.getElementById("check_status").style.background = "red";
                        document.getElementById("check_loader").style.display = "none";    
                        alert("Check Failed");
                        this.select_file();    
                    }            
                }) 
            }
        },
            
        wbench_restore_task() {
          alert(''+ login.$data.key + ' -- ' + modal.$data.selected_task + '' )
          this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('restore_task', [login.$data.key,'ldd',modal.$data.selected_task]))).then(response => {
              
              console.log(response);
              workspace.wb_load(); 
          });        
        },

       wbench_set_key(gpio_key, state) {
            //alert(gpio_key + '--' + state);
            var igpio_key = parseInt(gpio_key);
            var istate = parseInt(state);
            this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('wbench_set_key', [login.$data.key, igpio_key, istate]))).then(response => {
              console.log(response);
          });
        },
            
        wbench_keypad_press(keypad_id) {
            //alert(keypad_id);
            var  ikeypad_id = parseInt(keypad_id);
            this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('wbench_keypad_press', [login.$data.key, ikeypad_id]))).then(response => {
              console.log(response);
          });  
        },
            
        }, //Worspace-Methods-Ends
        }) //Worspace-Ends
      
    //------------------------------------------ Vue Test [Dummy] -------------- 
      /*var app = new Vue({
      el: '#app',
      data: {
      joses: 'Vue is Working',
      testings : false
      }
      })
*/
      //------------------------ USER Login -------------------------------- 
      var login = new Vue({
      el: '#login',
      data : {
      login: '',
      pass: '',
      key: '',
      data_xmlrpc: '',
      submit_button: true,
      loading: false,
      login_screen: true,
      },      
      methods: {  
      submit() {
      this.submit_button = false;
      this.loading = true;    
            this.$http.post(xmlrpc_url,(new XMLSerializer()).serializeToString($.xmlrpc.document('login', [this.login, this.pass]) )).then(response => {
                //console.log(response.body);
                this.data_xmlrpc = response.body; 
                this.fn_parser()})
      },
      
      fn_parser() {
      var text = this.data_xmlrpc;
      var parser, xmlDoc;
      parser = new DOMParser();
      xmlDoc = parser.parseFromString(text,"text/xml");
      workspace.$data.code = this.text;
      this.key = xmlDoc.getElementsByTagName("string")[0].childNodes[0].nodeValue;
      //alert(`${this.login} - ${this.pass} - ${this.key}`)
          if( this.key != "Authentication Failed") {
      this.loading = false;
      this.submit_button = true;
      this.login_screen = false;
      modules.$data.page = true; 
          }
      else {
          alert("Authentication Failed");
          window.location.reload(true);
      }
      }}})
    </script>
  </body>

</html>
